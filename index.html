<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ECMO/体外循環 高度管理ツール</title>
    <style>
        body { font-family: 'Helvetica Neue', Arial, sans-serif; background-color: #f0f2f5; padding: 20px; color: #333; }
        .container { max-width: 700px; margin: auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        h1 { font-size: 1.3rem; border-left: 5px solid #007bff; padding-left: 10px; color: #333; margin-bottom: 20px; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .input-group { display: flex; flex-direction: column; }
        label { font-size: 0.85rem; font-weight: bold; margin-bottom: 5px; color: #555; }
        input { padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 1rem; }
        button { grid-column: span 2; padding: 15px; background-color: #007bff; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 1.1rem; font-weight: bold; }
        button:hover { background-color: #0056b3; }
        .results { margin-top: 25px; display: none; }
        .result-card { background: #f8f9fa; border-radius: 8px; padding: 15px; margin-bottom: 10px; border-left: 4px solid #007bff; }
        .target-card { background: #fff4e5; border-left: 4px solid #ff9800; }
        .result-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        .result-label { font-size: 0.9rem; color: #666; }
        .result-value { font-size: 1.2rem; font-weight: bold; color: #222; }
        .highlight { color: #d9534f; }
        .footer-note { font-size: 0.75rem; color: #888; margin-top: 20px; line-height: 1.4; }
    </style>
</head>
<body>

<div class="container">
    <h1>ECMO/体外循環 管理指標計算</h1>
    
    <div class="grid">
        <div class="input-group">
            <label>身長 (cm)</label>
            <input type="number" id="height" placeholder="170" step="0.1">
        </div>
        <div class="input-group">
            <label>体重 (kg)</label>
            <input type="number" id="weight" placeholder="60" step="0.1">
        </div>
        <div class="input-group">
            <label>現在の送血流量 (L/min)</label>
            <input type="number" id="co" placeholder="4.0" step="0.01">
        </div>
        <div class="input-group">
            <label>現在のHb値 (g/dL)</label>
            <input type="number" id="hb" placeholder="10.0" step="0.1">
        </div>
        <div class="input-group">
            <label>動脈血酸素飽和度 SaO₂ (%)</label>
            <input type="number" id="sao2" value="100" step="0.1">
        </div>
        <div class="input-group">
            <label>静脈血酸素飽和度 SvO₂ (%)</label>
            <input type="number" id="svo2" value="75" step="0.1">
        </div>
        <button onclick="calculate()">計算を実行する</button>
    </div>

    <div class="results" id="output">
        <div class="result-card">
            <div class="result-row">
                <span class="result-label">体表面積 (BSA)</span>
                <span class="result-value"><span id="res-bsa">-</span> m²</span>
            </div>
            <div class="result-row">
                <span class="result-label">現在の心係数 (CI)</span>
                <span class="result-value"><span id="res-ci">-</span> L/min/m²</span>
            </div>
        </div>

        <div class="result-card target-card">
            <div class="result-row">
                <span class="result-label"><strong>目標CI 2.4 時の必要流量</strong></span>
                <span class="result-value highlight"><span id="res-target-flow">-</span> L/min</span>
            </div>
            <div class="result-row">
                <span class="result-label"><strong>目標比率 3:1 (DO₂i 300) に必要なHb</strong></span>
                <span class="result-value highlight"><span id="res-req-hb">-</span> g/dL</span>
            </div>
        </div>

        <div class="result-card">
            <div class="result-row">
                <span class="result-label">現在の酸素デリバリー (DO₂)</span>
                <span class="result-value"><span id="res-do2">-</span> mL/min</span>
            </div>
            <div class="result-row">
                <span class="result-label">現在のDO₂ / VO₂ 比</span>
                <span class="result-value"><span id="res-ratio">-</span></span>
            </div>
        </div>
    </div>
    
    <div class="footer-note">
        【計算根拠】<br>
        ・BSA: DuBois式を使用<br>
        ・必要Hb: $DO_2$ インデックスを 300 $mL/min/m^2$ 以上に維持するために必要な値を、現在の設定流量から逆算しています。<br>
        ・比率が 3.0 を下回る場合は、流量の増加または輸血を検討する指標となります。
    </div>
</div>

<script>
function calculate() {
    const h = parseFloat(document.getElementById('height').value);
    const w = parseFloat(document.getElementById('weight').value);
    const co = parseFloat(document.getElementById('co').value);
    const hb = parseFloat(document.getElementById('hb').value);
    const sao2 = parseFloat(document.getElementById('sao2').value) / 100;
    const svo2 = parseFloat(document.getElementById('svo2').value) / 100;

    if (!h || !w || !co || !hb) {
        alert("身長、体重、流量、Hbを入力してください。");
        return;
    }

    // 1. BSA (DuBois)
    const bsa = 0.007184 * Math.pow(h, 0.725) * Math.pow(w, 0.425);
    
    // 2. CI
    const ci = co / bsa;

    // 3. Target Flow for CI 2.4
    const targetFlow24 = bsa * 2.4;

    // 4. DO2 and Ratio
    const do2 = co * (hb * 1.34 * sao2) * 10;
    const vo2 = co * (hb * 1.34 * (sao2 - svo2)) * 10;
    const ratio = do2 / vo2;

    // 5. Required Hb for DO2 Index = 300 (Goal Directed Perfusion Standard)
    // Formula: 300 = (CO/BSA) * Hb * 1.34 * SaO2 * 10
    // Solving for Hb: Hb = 300 / ((CO/BSA) * 1.34 * SaO2 * 10)
    const reqHb = 300 / ((co / bsa) * 1.34 * sao2 * 10);

    // Display
    document.getElementById('output').style.display = 'block';
    document.getElementById('res-bsa').innerText = bsa.toFixed(2);
    document.getElementById('res-ci').innerText = ci.toFixed(2);
    document.getElementById('res-target-flow').innerText = targetFlow24.toFixed(2);
    document.getElementById('res-do2').innerText = Math.round(do2);
    document.getElementById('res-ratio').innerText = ratio.toFixed(2);
    document.getElementById('res-req-hb').innerText = reqHb.toFixed(1);
}
</script>

</body>
</html>